# 📦 DataStax Collector LAB

This repository sets up a local Apache Cassandra 4.1.1 Docker container that supports the [DataStax Diagnostic Collection](https://github.com/datastax/diagnostic-collection). It provides everything needed to gather detailed system information, configuration files, logs, and JMX metrics.

The purpose is to easily simulate a diagnostic health check by collecting relevant data.

---

## 🔧 Features

* 🛠️ **Pre-installed system tools** required by the DataStax collector:

  * Includes `ethtool`, `lsof`, `iostat`, `jcmd`, `netstat`, `lsblk`, and more.
* 🔐 **SSH server enabled** for optional remote diagnostics:

  * Default user: `root` | Password: `root`
* 🌐 **Dynamic IP configuration** for Cassandra:

  * Automatically sets `listen_address` and `rpc_address` based on container IP.
* 📡 **JMX support**:

  * Validated configuration for metrics collection via `nodetool` and JMX port `7199`.
* 🐳 **Dockerized deployment**:

  * Containerized setup easily buildable and runnable locally.
* ⚙️ **Diagnostic collector ready**:

  * Compatible with DataStax’s `ds-collector` tooling via Docker, supporting `-C` and `-X` modes.
* 🔒 **Optional artifact encryption**:

  * Uses collector-provided `*_secret.key` when `encrypt_uploads=true`.

* 🧬 **Multi-platform Docker support**: Runs on both `amd64` and `arm64` (e.g. Apple Silicon, Linux servers)


---

## 📁 Project Structure

```text
.
├── example_collector.conf       # Example configuration
├── README.md                    # Collector documentation
├── Dockerfile                   # Builds Cassandra container with extra tools
├── start-cassandra.sh           # Starts Cassandra with dynamic IP config
├── start-cassandra-container.sh # Builds and runs the container
├── docker-entrypoint-wrapper.sh # Entrypoint override for container setup
├── collector/                   # Extracted diagnostic collector bundle + key provided by DataStax (generated by Reuben)
│   ├── ds-collector             # Main collector script
│   ├── collector.conf           # Configuration file (example provided)
│   └── *_secret.key             # Optional encryption key (if provided)
````

---

## 🚀 Quick Start

### Option A: Use Pre-Built Image from Docker Hub (Recommended)

```bash
docker run -d \
  --name cassandra-collector \
  -p 9042:9042 \
  -p 7199:7199 \
  -p 22:22 \
  dieterfl/cassandra-collector
```

### Option B: Build Locally

```bash
./start-cassandra-container.sh
```

---

## 🐳 Docker Hub: How to Publish

### 1. Log in to Docker Hub

```bash
docker login
```

### 2. Tag your image

```bash
docker tag cassandra-collector <your-dockerhub-username>/cassandra-collector:latest
```

### 3. Push to Docker Hub

```bash
docker push <your-dockerhub-username>/cassandra-collector:latest
```

---

## 📦 Prepare the Diagnostic Collector

If you haven’t already:

```bash
tar -xvf ds-collector.*.tar
cd collector
```

Then:

* Copy the secret key (if applicable):

```bash
cp /path/to/*_secret.key .
```

* Edit the configuration file:

```bash
nano collector.conf
```

---

## 📝 Example `collector.conf`

```bash
use_docker="true"
hostName="cassandra-collector"
skipSudo="true"
jmxHost="127.0.0.1"
jmxPort="7199"
jmxSSL="false"
nodetoolCmd="/opt/cassandra/bin/nodetool"
cqlsh_host=127.0.0.1
cqlsh_port=9042
issueId="difli-01"
keyMD5sum="1687214ca092e751c671cda6fbd78669  difli-01_secret.key"
encrypt_uploads="true"
skipS3="false"
keyId="AKI..."
keySecret="NUp..."
git_branch="master"
git_sha="f7505e34640e400076ded906d7e9f212de6cd47f"
```

---

## 🧪 Run Diagnostics

### ✅ Test Cassandra Connectivity

Before collecting diagnostics, ensure that the collector can connect to Cassandra:

```bash
./ds-collector -T -f collector.conf -n cassandra-collector
````

> ⏳ **Note:** If you're using **Option A (Docker Hub Image)**, Cassandra might take 30-60 seconds to fully initialize. Wait a bit before running the test to avoid false connection errors.

### 📥 Collect Diagnostic Snapshot

```bash
./ds-collector -X -d -f collector.conf -n cassandra-collector
```

---

## 🔍 Useful Docker Commands

```bash
docker exec -it cassandra-collector bash          # Shell access
docker exec cassandra-collector nodetool status   # Check Cassandra health
```

---

## 📬 Troubleshooting

To enable verbose output and debug mode, run:

```bash
./ds-collector -X -d -v -f collector.conf -n cassandra-collector
````

This generates detailed output and writes a log file to your local machine at:

```
/tmp/datastax/ds-collector-<timestamp>.log
```

> 💡 Use this log to investigate issues like connection failures, missing dependencies, or Cassandra accessibility.

---

## 🏁 Notes

* You can reuse this setup for local debugging and cluster simulations
