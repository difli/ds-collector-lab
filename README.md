# ğŸ“¦ DataStax Collector LAB

This repository sets up a local Apache Cassandra 4.1.1 Docker container that supports the [DataStax Diagnostic Collection](https://github.com/datastax/diagnostic-collection). It provides everything needed to gather detailed system information, configuration files, logs, and JMX metrics.

The purpose is to easily simulate a diagnostic health check by collecting relevant data.

---

## ğŸ”§ Features

* ğŸ› ï¸ **Pre-installed system tools** required by the DataStax collector:

  * Includes `ethtool`, `lsof`, `iostat`, `jcmd`, `netstat`, `lsblk`, and more.
* ğŸ” **SSH server enabled** for optional remote diagnostics:

  * Default user: `root` | Password: `root`
* ğŸŒ **Dynamic IP configuration** for Cassandra:

  * Automatically sets `listen_address` and `rpc_address` based on container IP.
* ğŸ“¡ **JMX support**:

  * Validated configuration for metrics collection via `nodetool` and JMX port `7199`.
* ğŸ³ **Dockerized deployment**:

  * Containerized setup easily buildable and runnable locally.
* âš™ï¸ **Diagnostic collector ready**:

  * Compatible with DataStaxâ€™s `ds-collector` tooling via Docker, supporting `-C` and `-X` modes.
* ğŸ”’ **Optional artifact encryption**:

  * Uses collector-provided `*_secret.key` when `encrypt_uploads=true`.

* ğŸ§¬ **Multi-platform Docker support**: Runs on both `amd64` and `arm64` (e.g. Apple Silicon, Linux servers)


---

## ğŸ“ Project Structure

```text
.
â”œâ”€â”€ example_collector.conf       # Example configuration
â”œâ”€â”€ README.md                    # Collector documentation
â”œâ”€â”€ Dockerfile                   # Builds Cassandra container with extra tools
â”œâ”€â”€ start-cassandra.sh           # Starts Cassandra with dynamic IP config
â”œâ”€â”€ start-cassandra-container.sh # Builds and runs the container
â”œâ”€â”€ docker-entrypoint-wrapper.sh # Entrypoint override for container setup
â”œâ”€â”€ collector/                   # Extracted diagnostic collector bundle + key provided by DataStax (generated by Reuben)
â”‚   â”œâ”€â”€ ds-collector             # Main collector script
â”‚   â”œâ”€â”€ collector.conf           # Configuration file (example provided)
â”‚   â””â”€â”€ *_secret.key             # Optional encryption key (if provided)
````

---

## ğŸš€ Quick Start

### Option A: Use Pre-Built Image from Docker Hub (Recommended)

```bash
docker run -d \
  --name cassandra-collector \
  -p 9042:9042 \
  -p 7199:7199 \
  -p 22:22 \
  dieterfl/cassandra-collector
```

### Option B: Build Locally

```bash
./start-cassandra-container.sh
```

---

## ğŸ³ Docker Hub: How to Publish

### 1. Log in to Docker Hub

```bash
docker login
```

### 2. Tag your image

```bash
docker tag cassandra-collector <your-dockerhub-username>/cassandra-collector:latest
```

### 3. Push to Docker Hub

```bash
docker push <your-dockerhub-username>/cassandra-collector:latest
```

---

## ğŸ“¦ Prepare the Diagnostic Collector

If you havenâ€™t already:

```bash
tar -xvf ds-collector.*.tar
cd collector
```

Then:

* Copy the secret key (if applicable):

```bash
cp /path/to/*_secret.key .
```

* Edit the configuration file:

```bash
nano collector.conf
```

---

## ğŸ“ Example `collector.conf`

```bash
use_docker="true"
hostName="cassandra-collector"
skipSudo="true"
jmxHost="127.0.0.1"
jmxPort="7199"
jmxSSL="false"
nodetoolCmd="/opt/cassandra/bin/nodetool"
cqlsh_host=127.0.0.1
cqlsh_port=9042
issueId="difli-01"
keyMD5sum="1687214ca092e751c671cda6fbd78669  difli-01_secret.key"
encrypt_uploads="true"
skipS3="false"
keyId="AKI..."
keySecret="NUp..."
git_branch="master"
git_sha="f7505e34640e400076ded906d7e9f212de6cd47f"
```

---

## ğŸ§ª Run Diagnostics

### âœ… Test Cassandra Connectivity

Before collecting diagnostics, ensure that the collector can connect to Cassandra:

```bash
./ds-collector -T -f collector.conf -n cassandra-collector
````

> â³ **Note:** If you're using **Option A (Docker Hub Image)**, Cassandra might take 30-60 seconds to fully initialize. Wait a bit before running the test to avoid false connection errors.

### ğŸ“¥ Collect Diagnostic Snapshot

```bash
./ds-collector -X -d -f collector.conf -n cassandra-collector
```

---

## ğŸ” Useful Docker Commands

```bash
docker exec -it cassandra-collector bash          # Shell access
docker exec cassandra-collector nodetool status   # Check Cassandra health
```

---

## ğŸ“¬ Troubleshooting

To enable verbose output and debug mode, run:

```bash
./ds-collector -X -d -v -f collector.conf -n cassandra-collector
````

This generates detailed output and writes a log file to your local machine at:

```
/tmp/datastax/ds-collector-<timestamp>.log
```

> ğŸ’¡ Use this log to investigate issues like connection failures, missing dependencies, or Cassandra accessibility.

---

## ğŸ Notes

* You can reuse this setup for local debugging and cluster simulations
